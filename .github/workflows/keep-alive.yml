name: Keep Render Service Alive

on:
  schedule:
    # Run every 5 minutes to prevent Render free tier from sleeping (15 min timeout)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Faucet API with retry
        run: |
          echo "Pinging faucet to keep it alive..."

          MAX_RETRIES=3
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 https://starknet-faucet-gnq5.onrender.com/api/v1/info)
            echo "Response code: $response"

            if [ "$response" = "200" ]; then
              echo "✓ Faucet is alive and responding"
              exit 0
            fi

            if [ $i -lt $MAX_RETRIES ]; then
              echo "Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "⚠ Failed to reach faucet after $MAX_RETRIES attempts (this is normal if server is redeploying)"
          exit 0
